{% extends "base.html" %}

{% block title %}æ’ä»¶ç®¡ç†{% endblock %}

{% block content %}
<div class="page-header mb-4 fade-in">
    <h1>
        <i class="bi bi-puzzle"></i> æ’ä»¶ç®¡ç†
    </h1>
    <p class="text-muted">ç®¡ç†ä¸åŒçš„çˆ¬è™«æ’ä»¶æº</p>
</div>

<div class="row fade-in">
    <div class="col-12">
        <div class="data-table-wrapper">
<div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-plug"></i> å½“å‰å·²åŠ è½½çš„çˆ¬è™«æº ({{ plugins|length }})
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createPluginModal">
                        <i class="bi bi-plus-circle"></i> åˆ›å»ºæ’ä»¶
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                </div>
            </div>

            {% if plugins %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>æ’ä»¶åç§°</th>
                            <th>ç±»å‹</th>
                            <th>æè¿°</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plugin in plugins %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <strong>{{ plugin.name }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ plugin.type }}</span>
                            </td>
                            <td>
                                <small>{{ plugin.get('description', 'N/A') }}</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <p>æš‚æ— æ’ä»¶æ•°æ®ï¼Œè¯·ç¡®ä¿çˆ¬è™«æ­£å¸¸è¿è¡Œ</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- æ’ä»¶è¯´æ˜ -->
<div class="row mt-4 fade-in">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> æ’ä»¶ç®¡ç†è¯´æ˜
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <p><strong>æ’ä»¶ç±»å‹ï¼š</strong></p>
                    <ul class="mb-0">
                        <li><code>public</code> - å…¬å¼€äº‹åº™æ’ä»¶ï¼Œä¼šè‡ªåŠ¨åŠ è½½</li>
                        <li><code>private</code> - ç§äººäº‹åº™æ’ä»¶ï¼Œéœ€è¦æ‰‹åŠ¨éƒ¨ç½²</li>
                    </ul>
                </div>
                <p>å°†ä¸åŒçš„çˆ¬è™«æºæ”¯æŒä¸åŒçš„ä»£ç†ç½‘ç«™ï¼Œç›´æ¥é…ç½®ä¸åŒçš„çˆ¬è™«æºå³å¯æ‰©å±•ä½ çš„ä»£ç†æ± æ•°æ®æ¥æºã€‚</p>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºæ’ä»¶æ¨¡æ€æ¡† -->
<div class="modal fade" id="createPluginModal" tabindex="-1" aria-labelledby="createPluginLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="createPluginLabel">
                    <i class="bi bi-plus-circle"></i> åˆ›å»ºæ–°æ’ä»¶
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPluginForm">
                    <div class="mb-3">
                        <label for="pluginName" class="form-label">æ’ä»¶åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="pluginName" placeholder="ä¾‹å¦‚ï¼šmyproxyï¼ˆä¸è¦åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼‰" required>
                        <small class="form-text text-muted">æ¨¡å—åç§°ï¼Œå°†ä½œä¸ºæ–‡ä»¶åï¼ˆè‡ªåŠ¨æ·»åŠ .pyï¼‰</small>
                    </div>
                    <div class="mb-3">
                        <label for="pluginDescription" class="form-label">æè¿° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="pluginDescription" placeholder="ä¾‹å¦‚ï¼šMy proxy crawler, https://example.com" required>
                        <small class="form-text text-muted">æ’ä»¶æè¿°ï¼ˆä¼šä½œä¸ºDocstringï¼‰</small>
                    </div>
                    <div class="mb-3">
                        <label for="pluginUrl" class="form-label">API URL <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="pluginUrl" placeholder="https://example.com/api/proxies" required>
                        <small class="form-text text-muted">çˆ¬è™«éœ€è¦è®¿é—®açš„ API åœ°å€</small>
                    </div>
                    <div class="mb-3">
                        <label for="pluginResponse" class="form-label">å“åº”ç¤ºä¾‹</label>
                        <textarea class="form-control" id="pluginResponse" rows="4" placeholder='{"data": [{"ip": "127.0.0.1", "port": 8080}]}'></textarea>
                        <small class="form-text text-muted">API å“åº”ç¤ºä¾‹ï¼ˆJSON æ ¼å¼ï¼‰</small>
                    </div>
                    <div class="alert alert-info small">
                        <strong>æç¤ºï¼š</strong>æ’ä»¶å°†ä¼šè¢«ä¿å­˜åˆ° <code>proxypool/crawlers/private/</code> æ–‡ä»¶å¤¹ä¸­ã€‚
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" id="submitPluginBtn">åˆ›å»ºæ’ä»¶</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('submitPluginBtn');
    const form = document.getElementById('createPluginForm');
    
    submitBtn.addEventListener('click', async function() {
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const pluginName = document.getElementById('pluginName').value.trim();
        const pluginDescription = document.getElementById('pluginDescription').value.trim();
        const pluginUrl = document.getElementById('pluginUrl').value.trim();
        const pluginResponse = document.getElementById('pluginResponse').value.trim();
        
        // éªŒè¯æ’ä»¶åç§°
        if (!/^[a-zA-Z0-9_]+$/.test(pluginName)) {
            notifyUtils.error('æ’ä»¶åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
            return;
        }
        
        // æäº¤è¡¨å•
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>åˆ›å»ºä¸­...';
        
        try {
            const response = await fetch('/api/create_plugin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: pluginName,
                    description: pluginDescription,
                    url: pluginUrl,
                    response_example: pluginResponse
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                notifyUtils.success('æ’ä»¶åˆ›å»ºæˆåŠŸï¼');
                // æ¸…ç©ºè¡¨å•
                form.reset();
                // å…³é—­Modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createPluginModal'));
                modal.hide();
                // 1ç§’ååˆ·æ–°é¡µé¢
                setTimeout(() => location.reload(), 1000);
            } else {
                notifyUtils.error(data.message || 'åˆ›å»ºå¤±è´¥');
            }
        } catch (error) {
            console.error('é”™è¯¯:', error);
            notifyUtils.error('ç½‘ç»œé”™è¯¯: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'åˆ›å»ºæ’ä»¶';
        }
    });
});
</script>
{% endblock %}