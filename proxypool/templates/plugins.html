{% extends "base.html" %}

{% block title %}æ’ä»¶ç®¡ç†{% endblock %}

{% block content %}
<div class="page-header mb-4 fade-in">
    <h1>
        <i class="bi bi-puzzle"></i> æ’ä»¶ç®¡ç†
    </h1>
    <p class="text-muted">ç®¡ç†ä¸åŒçš„çˆ¬è™«æ’ä»¶æº</p>
</div>

<div class="row fade-in">
    <div class="col-12">
        <div class="data-table-wrapper">
<div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-plug"></i> å½“å‰å·²åŠ è½½çš„çˆ¬è™«æº ({{ plugins|length }})
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createPluginModal">
                        <i class="bi bi-plus-circle"></i> åˆ›å»ºæ’ä»¶
                    </button>
                    <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#uploadPluginModal">
                        <i class="bi bi-upload"></i> ä¸Šä¼ æ’ä»¶
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                </div>
            </div>

            {% if plugins %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>æ’ä»¶åç§°</th>
                            <th>ç±»å‹</th>
                            <th>æè¿°</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plugin in plugins %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <strong>{{ plugin.name }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ plugin.type }}</span>
                            </td>
                            <td>
                                <small>{{ plugin.get('description', 'N/A') }}</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <p>æš‚æ— æ’ä»¶æ•°æ®ï¼Œè¯·ç¡®ä¿çˆ¬è™«æ­£å¸¸è¿è¡Œ</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- æ’ä»¶è¯´æ˜ -->
<div class="row mt-4 fade-in">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> æ’ä»¶ç®¡ç†è¯´æ˜
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <p><strong>æ’ä»¶ç±»å‹ï¼š</strong></p>
                    <ul class="mb-0">
                        <li><code>public</code> - å…¬å…±æ’ä»¶ï¼Œä¼šè‡ªåŠ¨åŠ è½½</li>
                        <li><code>private</code> - ç§äººæ’ä»¶ï¼Œéœ€è¦æ‰‹åŠ¨éƒ¨ç½²</li>
                    </ul>
                </div>
                <p>å°†ä¸åŒçš„çˆ¬è™«æºæ”¯æŒä¸åŒçš„ä»£ç†ç½‘ç«™ï¼Œç›´æ¥é…ç½®ä¸åŒçš„çˆ¬è™«æºå³å¯æ‰©å±•ä½ çš„ä»£ç†æ± æ•°æ®æ¥æºã€‚</p>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºæ’ä»¶æ¨¡æ€æ¡† -->
<div class="modal fade" id="createPluginModal" tabindex="-1" aria-labelledby="createPluginLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="createPluginLabel">
                    <i class="bi bi-plus-circle"></i> åˆ›å»ºæ–°æ’ä»¶
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPluginForm">
                    <div class="mb-3">
                        <label for="pluginName" class="form-label">æ’ä»¶æ–‡ä»¶å <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="pluginName" placeholder="ä¾‹å¦‚ï¼šmycrawlerï¼ˆä¸éœ€è¦.pyåç¼€ï¼‰" required>
                            <span class="input-group-text">.py</span>
                        </div>
                        <small class="form-text text-muted">æ¨¡å—åç§°ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="pluginCode" class="form-label">çˆ¬è™«ä»£ç  <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="pluginCode" rows="20" placeholder="è¯·å†™å…¥çˆ¬è™«ç±»çš„å®Œæ•´ä»£ç ..." required></textarea>
                        <small class="form-text text-muted d-block mt-2">
                            <strong>ä»£ç æ¨¡æ¿ç¤ºä¾‹ï¼š</strong>
                        </small>
                        <pre class="bg-light p-2 mt-2 small" style="border: 1px solid #dee2e6; border-radius: 0.25rem; color: #333;"><code style="color: #333;">from pyquery import PyQuery as pq
from proxypool.schemas.proxy import Proxy
from proxypool.crawlers.base import BaseCrawler

BASE_URL = 'http://example.com/{page}.html'
MAX_PAGE = 3

class MycrawlerCrawler(BaseCrawler):
    # è¿™é‡Œå¡«å†™æ’ä»¶çš„æè¿°ä¿¡æ¯ï¼ˆå¿…å¡«ï¼‰
    """
    mycrawler crawler, http://example.com
    """
    urls = [BASE_URL.format(page=page) for page in range(1, MAX_PAGE + 1)]

    def parse(self, html):
        """
        parse html file to get proxies
        :return:
        """
        # åœ¨è¿™é‡Œå®ç°è§£æé€»è¾‘
        doc = pq(html)
        for item in doc('.proxy-item').items():
            host = item.find('.ip').text()
            port = int(item.find('.port').text())
            yield Proxy(host=host, port=port)</code></pre>
                    </div>
                    
                    <div class="alert alert-info small">
                        <strong>æç¤ºï¼š</strong>
                        <ul class="mb-0">
                            <li>æ ¸å¿ƒæ˜¯å®šä¹‰ä¸€ä¸ªç»§æ‰¿ <code>BaseCrawler</code> çš„ç±»</li>
                            <li>ä¸¥æ ¼æŒ‰ç…§ README.md çš„è§„èŒƒç¼–å†™ï¼ˆåŒ…å«ç±»åã€urlsã€parseæ–¹æ³•çš„å®šä¹‰ï¼‰</li>
                            <li>ç±»åéœ€è¦è·Ÿæ–‡ä»¶ååŒ¹é…ï¼ˆæ–‡ä»¶å: mycrawler â†’ ç±»å: MycrawlerCrawlerï¼‰</li>
                            <li>éœ€è¦ä½¿ç”¨é©å½“çš„è§£æåº“ï¼špyqueryã€jsonã€re ç­‰</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" id="submitPluginBtn">åˆ›å»ºæ’ä»¶</button>
            </div>
        </div>
    </div>
</div>

<!-- ä¸Šä¼ æ’ä»¶æ¨¡æ€æ¡† -->
<div class="modal fade" id="uploadPluginModal" tabindex="-1" aria-labelledby="uploadPluginLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="uploadPluginLabel">
                    <i class="bi bi-upload"></i> ä¸Šä¼ æ’ä»¶
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadPluginForm">
                    <div class="mb-3">
                        <label for="pluginFile" class="form-label">é€‰æ‹© Python æ–‡ä»¶ <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="pluginFile" accept=".py" required>
                        <small class="form-text text-muted d-block mt-2">ä»…æ¥å— .py æ–‡ä»¶ï¼Œä¸Šä¼ åä¸ä¼šè¦†ç›–å·²æœ‰çš„æ’ä»¶</small>
                    </div>
                    
                    <div class="alert alert-warning small">
                        <strong><i class="bi bi-exclamation-triangle"></i> æ³¨æ„ï¼š</strong>
                        <ul class="mb-0">
                            <li>æ’ä»¶ä»£ç å¿…é¡»ç¬¦åˆ README.md çš„è§„èŒƒ</li>
                            <li>æ–‡ä»¶åå°†ä½œä¸ºæ’ä»¶åç§°ï¼ˆè‡ªåŠ¨å»é™¤ .py åç¼€ï¼‰</li>
                            <li>æ’ä»¶å­˜ä¿åˆ° private æ–‡ä»¶å¤¹</li>
                            <li>æ–‡ä»¶åå·²å­˜åœ¨æ—¶ä¸ä¼šä¸Šä¼ </li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-info" id="submitUploadBtn">ä¸Šä¼ æ’ä»¶</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // åˆ›å»ºæ’ä»¶é€»è¾‘
    const submitBtn = document.getElementById('submitPluginBtn');
    const form = document.getElementById('createPluginForm');
    
    submitBtn.addEventListener('click', async function() {
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const pluginName = document.getElementById('pluginName').value.trim();
        const pluginCode = document.getElementById('pluginCode').value.trim();
        
        // éªŒè¯æ’ä»¶åç§°
        if (!/^[a-zA-Z0-9_]+$/.test(pluginName)) {
            notifyUtils.error('æ’ä»¶åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
            return;
        }
        
        // éªŒè¯æ’ä»¶ä»£ç æ˜¯å¦åŒ…å«å¿…è¦çš„ç»“æ„
        if (!pluginCode.includes('BaseCrawler') || !pluginCode.includes('def parse')) {
            notifyUtils.error('æ’ä»¶ä»£ç å¿…é¡»ç»§æ‰¿BaseCrawlerä¸”åŒ…å«parseæ–¹æ³•');
            return;
        }
        
        // æäº¤è¡¨å•
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>åˆ›å»ºä¸­...';
        
        try {
            const response = await fetch('/api/create_plugin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: pluginName,
                    code: pluginCode
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                notifyUtils.success('æ’ä»¶åˆ›å»ºæˆåŠŸï¼');
                // æ¸…ç©ºè¡¨å•
                form.reset();
                // å…³é—­Modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createPluginModal'));
                modal.hide();
                // 1ç§’ååˆ·æ–°é¡µé¢
                setTimeout(() => location.reload(), 1000);
            } else {
                notifyUtils.error(data.message || 'åˆ›å»ºå¤±è´¥');
            }
        } catch (error) {
            console.error('é”™è¯¯:', error);
            notifyUtils.error('ç½‘ç»œé”™è¯¯: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'åˆ›å»ºæ’ä»¶';
        }
    });
    
    // ä¸Šä¼ æ’ä»¶é€»è¾‘
    const uploadBtn = document.getElementById('submitUploadBtn');
    const uploadForm = document.getElementById('uploadPluginForm');
    const pluginFileInput = document.getElementById('pluginFile');
    
    uploadBtn.addEventListener('click', async function() {
        if (!pluginFileInput.files || pluginFileInput.files.length === 0) {
            notifyUtils.error('è¯·é€‰æ‹©ä¸€ä¸ªPythonæ–‡ä»¶');
            return;
        }
        
        const file = pluginFileInput.files[0];
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        if (!file.name.endsWith('.py')) {
            notifyUtils.error('ä»…æ¥å— .py æ–‡ä»¶');
            return;
        }
        
        // æ‰§è¡Œä¸Šä¼ 
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ä¸Šä¼ ä¸­...';
        
        try {
            const fileContent = await file.text();
            const fileName = file.name.replace(/\.py$/, ''); // ç¦»é™¤ .py åç¼€
            
            const response = await fetch('/api/upload_plugin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: fileName,
                    code: fileContent
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                notifyUtils.success('æ’ä»¶ä¸Šä¼ æˆåŠŸï¼');
                // æ¸…ç©ºè¡¨å•
                uploadForm.reset();
                // å…³é—­Modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('uploadPluginModal'));
                modal.hide();
                // 1ç§’ååˆ·æ–°é¡µé¢
                setTimeout(() => location.reload(), 1000);
            } else {
                notifyUtils.error(data.message || 'ä¸Šä¼ å¤±è´¥');
            }
        } catch (error) {
            console.error('é”™è¯¯:', error);
            notifyUtils.error('ç½‘ç»œé”™è¯¯: ' + error.message);
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = 'ä¸Šä¼ æ’ä»¶';
        }
    });
});
</script>
{% endblock %}